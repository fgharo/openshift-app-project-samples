pipeline {
    options {
        // set a timeout of 60 minutes for this pipeline
        timeout(time: 60, unit: 'MINUTES')
    }

    agent {
      node {
          label 'nodejs'
    	}
    }

    environment {
      WORKING_DIRECTORY = 'tictactoe'
    }

    stages {
        stage('Loading Environment Vars'){
          steps{
            dir(env.WORKING_DIRECTORY){
              load "Jenkinsfile-properties.groovy"
            }
          }

        }

        stage('Installing Dependencies'){
          steps {
            dir(env.WORKING_DIRECTORY){
              sh 'npm install'
            }
          }
        }

        stage('Run Unit Tests') {
            steps {
                dir(env.WORKING_DIRECTORY){
                // test hanging.
                //  sh 'npm run test-headless'
                }
            }
        }

        stage('Static Code Analysis') {
            steps {
                dir(env.WORKING_DIRECTORY){
                //  sh 'npm run lint'
                }
            }
        }

        stage('Compile & Build Dist') {
            steps {
                dir(env.WORKING_DIRECTORY){
                  sh 'npm run build'
                }
            }
        }

        stage('Update Openshift Dev Container Image') {
            steps {
                sh '''
                    oc project ${DEV_PROJECT}
                    oc set triggers dc/${APP_NAME} --manual
      			        oc start-build bc/${APP_NAME} --from-dir=${PATH_TO_BINARY_DIR} --wait=true --follow=true
                   '''
            }
        }
    }
}
